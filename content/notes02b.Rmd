---
title: "Week 2-B Lecture Notes: List Columns"
subtitle: "**Development** Version 0.9000"
output: html_document
---

```{r, echo = FALSE, message = FALSE, warning = FALSE}
week_num <- 9  # 1 through 14
#-------------
source(here::here("content", "dates.R"))
library(stringr)
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, 
                      results = "asis", error = TRUE)
letter <- if (week_num <= 7) "A" else "B"
tues_class_num <- paste0(str_pad(week_num * 2 - 2, width = 2, pad = 0), letter)
tues_date <- lec0 + days((week_num - 1) * 7)
thurs_date <- tues_date + days(2)
```


```{r tues-date}
cat(format(tues_date, "%A, %b %d"), "-", 
    format(thurs_date, "%A, %b %d"))
```

## Learning Objectives

Did you know that a column of a tibble can contain a list -- not just a vector? This week explores when such a thing would come in handy, and how to work with list columns. 

From this week, students are anticipated to be able to:

- Use the `map` family of functions from the purrr package to iteratively apply a function.
- Create and operate on list columns in a tibble using `nest()`, `unnest()`, and the `map()` family of functions.
- Define functions on-the-fly within a `map` function using shortcuts.
- Apply list columns to cases in data analysis: columns of models, columns of nested lists (JSON-style data), and operating on entire groups within a tibble. 

## Resources

These resources are meant to be _paired_ with this week, not necessarily digested _before_ class.

- STAT 545 Episode 2-B (released later)
- [R4DS Chapter 21: Iteration](https://r4ds.had.co.nz/iteration.html) for purrr
    - 21.1 for an intro
    - 21.5 for the `map` family of functions
    - The intro of 21.7 for the `map2` and `pmap` families.
- ["List Columns"](https://jennybc.github.io/purrr-tutorial/ls13_list-columns.html) from [Jenny's purrr tutorial](https://jennybc.github.io/purrr-tutorial/index.html)
- ["Nested data" article](https://tidyr.tidyverse.org/articles/nest.html) on tidyr's website.

By the way, why use the `map` functions over `for` loops? Aside from the what's said at [R4DS's Section 21.4](https://r4ds.had.co.nz/iteration.html#for-loops-vs.-functionals), the `map` family encourages the input vector(s) and function to be carefully defined first, whereas a `for` loop is more of a free-for-all. Using `map()` is also more readable, is pipe-friendly, and jibes well with list columns in tibbles. 

### Additional Resources

Want to dig deeper? These resources can help.

- [Advanced R Chapter 9: Functionals](https://adv-r.hadley.nz/functionals.html) -- looking at purrr and `map()` from a programming perspective. 
- [tidyr's rectangling vignette](https://tidyr.tidyverse.org/articles/rectangle.html) -- for handling deeply nested lists (JSON-style data), similar to tidyr's `pivot` functions. 

## Quizzes

**Quiz 3-B**

1. True or False: `map(1:3, ~ function(x) x ^ 2)` returns the list `list(1, 4, 9)`.
2. You write a function `square()` that squares its input -- but the first thing it does is print a message to the screen! True or False: `map_dbl(1:10, square)` will throw an error, because the output is not a `dbl` (a number) -- it contains the message, too.


## Demonstration

```{r}
library(tidyverse)
library(palmerpenguins)
library(distplyr)
```


Here are some additional exercises that we may cover in class.

### Demo 1: `map2`

Using the `palmerpenguins::penguins` tibble: 

1. Make a Normal distribution using `distplyr::dst_norm()` for the body mass of each species, using estimates taken from `mean()` and `var()`. Title the column `distribution`.
2. Calculate the 0.975-quantile from each distribution using `distplyr::eval_quantile()`. Try this by making a new column of distributions, and by not.

Starter code:

```
(demo1 <- penguins %>% 
  group_by(species) %>% 
  summarise(mean = mean(body_mass_g, na.rm = TRUE),
            var  = var(body_mass_g, na.rm = TRUE)))
```

Answer:

```{r}
(demo1 <- penguins %>% 
  group_by(species) %>% 
  summarise(mean = mean(body_mass_g, na.rm = TRUE),
            var  = var(body_mass_g, na.rm = TRUE)))
```


### Demo 2: `unnest()`

`unnest()` need not always be paired with `nest()`. For the above distributions, evaluate the 0.25, 0.50, and 0.75 quantiles using the `distplyr::enframe_quantile()` function.

Starter code:

```
demo1 %>% 
  mutate(quantiles = FILL_THIS_IN)
```

Answer

```{r}
demo1 %>% 
  mutate(quantiles = FILL_THIS_IN)
```

