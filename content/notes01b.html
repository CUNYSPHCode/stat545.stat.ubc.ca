---
title: "Week 1-B Lecture Notes: R Functions for Data Analysis"
subtitle: "Version 1.0"
output: html_document
---



<p>Tuesday, Oct 27 - Thursday, Oct 29</p>
<div id="learning-objectives" class="section level2">
<h2>Learning Objectives</h2>
<p>Key topics this week:</p>
<ul>
<li>Start getting a sense of when to make a function in a data analysis (we will build on this next week).</li>
<li>Workflow for building a function: start interactively, wrap it as a function. <code>return()</code>. Argument names.</li>
<li>Fortify a function:
<ul>
<li>generalize the function and use smart defaults; <code>NA</code> handling, and ellipses package <a href="https://ellipsis.r-lib.org/">https://ellipsis.r-lib.org/</a></li>
<li>provide useful error messages; sidebar: <code>if</code> statements</li>
<li>Unit tests, and (sidebar) assertions</li>
</ul></li>
<li>Data masking in a function.</li>
<li>Documenting a function</li>
</ul>
<p>Possible topics this week:</p>
<ul>
<li><code>try()</code> and <code>withTimeout()</code>.</li>
<li>environments and scoping. Perhaps <code>search()</code>; <code>with()</code>.</li>
</ul>
<p>What we’re <em>not</em> covering (this week):</p>
<ul>
<li>Documenting functions with roxygen2 (Week 3)</li>
<li>S3 objects (and other object oriented styles) (Week 3)</li>
</ul>
</div>
<div id="prepare-for-class" class="section level2">
<h2>Prepare for Class</h2>
<p>Since this is the first week of Part B, I won’t be anticipating you to digest material beforehand. Plus, the video for this week won’t come until later in the week.</p>
<p>Instead, I suggest digesting this content throughout the week:</p>
<ul>
<li>Read <a href="https://stat545.com/functions-part1.html">stat545.com Functions, Parts 1-3</a></li>
<li>Watch STAT 545 Episode 1-B video series (I will announce when it’s available)</li>
</ul>
</div>
<div id="quiz-1-b" class="section level2">
<h2>Quiz 1-B</h2>
<p>Consider the following code:</p>
<pre><code>x &lt;- 1
f &lt;- function(t) {
  x &lt;- -1
  if (x &gt; 0) return(t)
  x * t + 1
  x * t
}
f(1)</code></pre>
<ol style="list-style-type: decimal">
<li>True or False: the output of <code>f(1)</code> is <code>-1</code>.</li>
<li>True or False: after running the above code, <code>x</code> is <code>-1</code>.</li>
</ol>
</div>
<div id="quiz-2-b" class="section level2">
<h2>Quiz 2-B</h2>
<ol style="list-style-type: decimal">
<li>True or False: Curly-curly <code>{{</code> can be used whenever we want to refer to column names outright, such as when subsetting in base R with <code>[[</code>.</li>
<li>You’ve made a function <code>quick_scatter()</code> that you can pipe a tibble into, and outputs a scatterplot of two variables. So far, you’re only using the function to explore the data for your own eyes (perhaps even putting your code directly in the console). True or False: at this point, you should stop and make sure your function is documented and has formal unit tests.</li>
</ol>
</div>
<div id="demonstration" class="section level2">
<h2>Demonstration</h2>
<pre class="r"><code>library(tidyverse)
library(gapminder)</code></pre>
<p>Sometimes it’s useful to work with the <em>log</em> of a variable with a positive skew, such as <code>gapminder</code>’s GDP per capita:</p>
<pre class="r"><code>cowplot::plot_grid(
  ggplot(gapminder, aes(gdpPercap)) +
    geom_histogram() +
    theme_minimal(),
  ggplot(gapminder, aes(log(gdpPercap))) +
    geom_histogram() +
    theme_minimal()
)</code></pre>
<pre><code>## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.
## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
<p><img src="/notes01b_files/figure-html/unnamed-chunk-3-1.png" width="480" style="display: block; margin: auto;" />
And, it’s sometimes useful to scale a variable to have mean 0 and variance 1. We’ll do both:</p>
<pre class="r"><code>gapminder %&gt;% 
  mutate(gdpPercap_scaled = (log(gdpPercap) - mean(gdpPercap)) / sd(gdpPercap),
         pop = (log(pop) - mean(pop)) / sd(gdpPercap))</code></pre>
<pre><code>## # A tibble: 1,704 x 7
##    country     continent  year lifeExp    pop gdpPercap gdpPercap_scaled
##    &lt;fct&gt;       &lt;fct&gt;     &lt;int&gt;   &lt;dbl&gt;  &lt;dbl&gt;     &lt;dbl&gt;            &lt;dbl&gt;
##  1 Afghanistan Asia       1952    28.8 -3003.      779.           -0.731
##  2 Afghanistan Asia       1957    30.3 -3003.      821.           -0.731
##  3 Afghanistan Asia       1962    32.0 -3003.      853.           -0.731
##  4 Afghanistan Asia       1967    34.0 -3003.      836.           -0.731
##  5 Afghanistan Asia       1972    36.1 -3003.      740.           -0.731
##  6 Afghanistan Asia       1977    38.4 -3003.      786.           -0.731
##  7 Afghanistan Asia       1982    39.9 -3003.      978.           -0.731
##  8 Afghanistan Asia       1987    40.8 -3003.      852.           -0.731
##  9 Afghanistan Asia       1992    41.7 -3003.      649.           -0.731
## 10 Afghanistan Asia       1997    41.8 -3003.      635.           -0.731
## # … with 1,694 more rows</code></pre>
<pre class="r"><code>gapminder %&gt;% 
  mutate(across(c(&quot;gdpPercap&quot;, &quot;pop&quot;), ~ (log(.) - mean(.)) / sd(.) ))</code></pre>
<pre><code>## # A tibble: 1,704 x 6
##    country     continent  year lifeExp    pop gdpPercap
##    &lt;fct&gt;       &lt;fct&gt;     &lt;int&gt;   &lt;dbl&gt;  &lt;dbl&gt;     &lt;dbl&gt;
##  1 Afghanistan Asia       1952    28.8 -0.279    -0.731
##  2 Afghanistan Asia       1957    30.3 -0.279    -0.731
##  3 Afghanistan Asia       1962    32.0 -0.279    -0.731
##  4 Afghanistan Asia       1967    34.0 -0.279    -0.731
##  5 Afghanistan Asia       1972    36.1 -0.279    -0.731
##  6 Afghanistan Asia       1977    38.4 -0.279    -0.731
##  7 Afghanistan Asia       1982    39.9 -0.279    -0.731
##  8 Afghanistan Asia       1987    40.8 -0.279    -0.731
##  9 Afghanistan Asia       1992    41.7 -0.279    -0.731
## 10 Afghanistan Asia       1997    41.8 -0.279    -0.731
## # … with 1,694 more rows</code></pre>
<p>Where might there be repetition in this analysis? Where <strong>is</strong> there repetition?</p>
<ul>
<li>Doing this scaling over and over again throughout the analysis.</li>
<li>Repetition across multiple variables, like <code>pop</code> and <code>lifeExp</code></li>
<li><code>gdpPercap</code> appears three times.</li>
</ul>
<p>Solve the problem of repetition by writing <em>functions</em>.</p>
<ol style="list-style-type: decimal">
<li>Turn the above into a function.</li>
</ol>
<pre class="r"><code>my_scale &lt;- function(x) {
  (log(x) - mean(x)) / sd(x)
}

# my_scale(gapminder$gdpPercap)
gapminder %&gt;% 
  mutate(gdpPercap = my_scale(gdpPercap),
         pop = my_scale(pop))</code></pre>
<pre><code>## # A tibble: 1,704 x 6
##    country     continent  year lifeExp    pop gdpPercap
##    &lt;fct&gt;       &lt;fct&gt;     &lt;int&gt;   &lt;dbl&gt;  &lt;dbl&gt;     &lt;dbl&gt;
##  1 Afghanistan Asia       1952    28.8 -0.279    -0.731
##  2 Afghanistan Asia       1957    30.3 -0.279    -0.731
##  3 Afghanistan Asia       1962    32.0 -0.279    -0.731
##  4 Afghanistan Asia       1967    34.0 -0.279    -0.731
##  5 Afghanistan Asia       1972    36.1 -0.279    -0.731
##  6 Afghanistan Asia       1977    38.4 -0.279    -0.731
##  7 Afghanistan Asia       1982    39.9 -0.279    -0.731
##  8 Afghanistan Asia       1987    40.8 -0.279    -0.731
##  9 Afghanistan Asia       1992    41.7 -0.279    -0.731
## 10 Afghanistan Asia       1997    41.8 -0.279    -0.731
## # … with 1,694 more rows</code></pre>
<pre class="r"><code>gapminder %&gt;% 
  mutate(across(c(&quot;gdpPercap&quot;, &quot;pop&quot;), my_scale))</code></pre>
<pre><code>## # A tibble: 1,704 x 6
##    country     continent  year lifeExp    pop gdpPercap
##    &lt;fct&gt;       &lt;fct&gt;     &lt;int&gt;   &lt;dbl&gt;  &lt;dbl&gt;     &lt;dbl&gt;
##  1 Afghanistan Asia       1952    28.8 -0.279    -0.731
##  2 Afghanistan Asia       1957    30.3 -0.279    -0.731
##  3 Afghanistan Asia       1962    32.0 -0.279    -0.731
##  4 Afghanistan Asia       1967    34.0 -0.279    -0.731
##  5 Afghanistan Asia       1972    36.1 -0.279    -0.731
##  6 Afghanistan Asia       1977    38.4 -0.279    -0.731
##  7 Afghanistan Asia       1982    39.9 -0.279    -0.731
##  8 Afghanistan Asia       1987    40.8 -0.279    -0.731
##  9 Afghanistan Asia       1992    41.7 -0.279    -0.731
## 10 Afghanistan Asia       1997    41.8 -0.279    -0.731
## # … with 1,694 more rows</code></pre>
<ol start="2" style="list-style-type: decimal">
<li>Try <code>across()</code> for multiple variables.</li>
<li>Test the function: first informally, then formally</li>
<li>Sidebar: assertions</li>
<li>Fortify: <code>NA</code> handling, ellipses, error messages and <code>if</code> statements, verbose option.</li>
</ol>
<p>Other exercises:</p>
<ul>
<li>Ellipses by making a strict <code>mean()</code> function that only accepts numeric.</li>
<li>Curly-Curly with ggplot2: scatterplot of x vs. y (this is called a “data mask”)</li>
<li><code>as.formula</code> with <code>lm()</code>; polynomial.</li>
<li>A function shouldn’t do too much. Should do one thing well.
<ul>
<li>Example of a function that does too much: <a href="https://github.com/vincenzocoia/cnqr/blob/master/R/cnqr.R">my <code>cnqr()</code> function from my PhD</a>.</li>
<li>Does the scaling function above do too much?</li>
</ul></li>
<li>Check out the assignment.</li>
<li>Time left? <code>try()</code> and <code>withTimeout()</code>.</li>
</ul>
</div>
